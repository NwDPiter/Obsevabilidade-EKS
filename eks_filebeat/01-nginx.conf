input {
  beats {
    port => 5044
    codec => "json"
  }
}

filter {
  # Filtro principal para logs Nginx
  if [fields][log_type] == "nginx_access" {
    json {
      source => "message"
    }
    
    # Data e timestamp
    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
      timezone => "America/Sao_Paulo"
    }
    
    # GeoIP para localização
    geoip {
      source => "remote_addr"
      target => "geoip"
    }
    
    # User Agent para dispositivo/navegador
    useragent {
      source => "http_user_agent"
      target => "user_agent"
    }
    
    # Parse da requisição
    grok {
      match => { 
        "request" => "^%{WORD:http_method} %{NOTSPACE:request_uri} HTTP/%{NUMBER:http_version}$" 
      }
    }
    
    # Definir tipo de evento baseado na requisição
    ruby {
      code => '
        event.set("event_type", "page_view")
        event.set("session_id", event.get("remote_addr") + "-" + Time.now.strftime("%Y%m%d"))
        
        # Simular diferentes tipos de evento para demo
        events = ["session_start", "page_view", "click", "first_visit", "user_engagement"]
        if rand(10) == 1
          event.set("event_type", events.sample)
        end
        
        # Simular novos usuários (20% dos acessos)
        if rand(5) == 1
          event.set("is_new_user", true)
        else
          event.set("is_new_user", false)
        end
      '
    }
    
    # Calcular engajamento (tempo na página simulado)
    ruby {
      code => '
        event.set("engagement_time", rand(30) + 1)
      '
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "web-analytics-%{+YYYY.MM.dd}"
  }
}