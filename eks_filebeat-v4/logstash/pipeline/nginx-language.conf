input {
  file {
    path => "/var/log/nginx/access.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => "plain"
  }
}

filter {
  # Extrair apenas os campos essenciais + accept_language
  dissect {
    mapping => {
      "message" => '%{client_ip} - %{user} [%{timestamp}] "%{http_method} %{url} HTTP/%{http_version}" %{status} %{bytes} "%{referer}" "%{user_agent}" "%{accept_language}"'
    }
  }

  # Foco total no processamento do idioma
  ruby {
    code => '
      # Limpar e extrair idioma principal
      if event.get("accept_language") && event.get("accept_language") != "-"
        raw_lang = event.get("accept_language").gsub(/^"|"$/, "")
        
        # Extrair primeiro idioma (antes da primeira vírgula)
        primary_lang = raw_lang.split(",").first
        
        # Limpar quality weights (;q=0.9)
        clean_lang = primary_lang.split(";").first.strip.downcase
        
        event.set("language.raw", raw_lang)
        event.set("language.primary", clean_lang)
        event.set("language.has_preferences", raw_lang.include?(","))
        
        # Detectar se tem múltiplos idiomas
        if raw_lang.include?(",")
          all_langs = raw_lang.split(",").map { |lang| lang.split(";").first.strip.downcase }
          event.set("language.all", all_langs)
          event.set("language.count", all_langs.size)
        else
          event.set("language.count", 1)
        end
      else
        # Caso não tenha accept_language
        event.set("language.primary", "not_detected")
        event.set("language.raw", "not_provided")
      end
    '
  }

  # Mapear códigos para nomes amigáveis
  translate {
    field => "language.primary"
    destination => "language.name" 
    dictionary => {
      "pt"       => "Português"
      "pt-br"    => "Português Brasileiro"
      "pt-pt"    => "Português Europeu"
      "en"       => "Inglês"
      "en-us"    => "Inglês Americano"
      "en-gb"    => "Inglês Britânico"
      "en-au"    => "Inglês Australiano"
      "es"       => "Espanhol"
      "es-es"    => "Espanhol Europeu"
      "es-mx"    => "Espanhol Mexicano"
      "fr"       => "Francês"
      "fr-fr"    => "Francês Francês"
      "fr-ca"    => "Francês Canadense"
      "de"       => "Alemão"
      "de-de"    => "Alemão Alemão"
      "it"       => "Italiano"
      "ja"       => "Japonês"
      "zh"       => "Chinês"
      "zh-cn"    => "Chinês Simplificado"
      "zh-tw"    => "Chinês Tradicional"
      "ru"       => "Russo"
      "ko"       => "Coreano"
      "ar"       => "Árabe"
      "hi"       => "Hindi"
      "not_detected" => "Não Detectado"
    }
    fallback => "Outro"
  }

  # Categorizar por grupo de idiomas
  translate {
    field => "language.primary"
    destination => "language.group"
    dictionary => {
      "pt"       => "Português"
      "pt-br"    => "Português"
      "pt-pt"    => "Português"
      "en"       => "Inglês"
      "en-us"    => "Inglês"
      "en-gb"    => "Inglês"
      "en-au"    => "Inglês"
      "es"       => "Espanhol"
      "es-es"    => "Espanhol"
      "es-mx"    => "Espanhol"
      "fr"       => "Francês"
      "fr-fr"    => "Francês"
      "fr-ca"    => "Francês"
      "de"       => "Alemão"
      "de-de"    => "Alemão"
      "it"       => "Italiano"
      "ja"       => "Japonês"
      "zh"       => "Chinês"
      "zh-cn"    => "Chinês"
      "zh-tw"    => "Chinês"
      "ru"       => "Russo"
      "ko"       => "Coreano"
      "ar"       => "Árabe"
      "hi"       => "Hindi"
    }
    fallback => "Outro"
  }

  # Região do idioma (simplificado)
  translate {
    field => "language.primary"
    destination => "language.region"
    dictionary => {
      "pt"       => "Portugal"
      "pt-br"    => "Brasil"
      "pt-pt"    => "Portugal"
      "en"       => "Internacional"
      "en-us"    => "EUA"
      "en-gb"    => "Reino Unido"
      "en-au"    => "Austrália"
      "es"       => "Internacional"
      "es-es"    => "Espanha"
      "es-mx"    => "México"
      "fr"       => "Internacional"
      "fr-fr"    => "França"
      "fr-ca"    => "Canadá"
      "de"       => "Alemanha"
      "de-de"    => "Alemanha"
      "it"       => "Itália"
      "ja"       => "Japão"
      "zh"       => "China"
      "zh-cn"    => "China"
      "zh-tw"    => "Taiwan"
      "ru"       => "Rússia"
      "ko"       => "Coreia"
      "ar"       => "Mundo Árabe"
      "hi"       => "Índia"
    }
    fallback => "Internacional"
  }

  # Timestamp
  date {
    match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
    target => "@timestamp"
  }

  # Converter campos numéricos
  mutate {
    convert => {
      "status" => "integer"
      "bytes" => "integer"
    }
    
    # Campos essenciais para análise
    rename => {
      "client_ip" => "source.ip"
      "http_method" => "http.request.method"
      "url" => "url.path"
      "status" => "http.response.status_code"
      "bytes" => "http.response.body.bytes"
      "referer" => "http.referer"
      "user_agent" => "user_agent.original"
    }
    
    # Remover campos temporários
    remove_field => [ "timestamp", "http_version", "user", "message" ]
  }

  # User Agent básico (apenas para browser vs bot)
  if [user_agent.original] {
    grok {
      match => { 
        "user_agent.original" => [
          "(?i)bot|crawl|spider|slurp|feed",
          "(?i)mobile|android|iphone",
          "(?i)firefox|chrome|safari|edge"
        ]
      }
      add_tag => [ "is_bot" ]
    }
    
    if "is_bot" not in [tags] {
      mutate {
        add_tag => [ "is_browser" ]
      }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "nginx-languages-%{+yyyy.MM.dd}"
  }

  # Para debug - ver os campos de idioma
  stdout { 
    codec => rubydebug 
    # Mostrar apenas campos relevantes para debug
    # metadata => true
  }
}